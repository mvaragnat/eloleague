<div class="games-container">
  <div class="page-header">
    <h1><%= t('elo.title') %></h1>
  </div>

  <div class="card">
    <div class="card-body">
      <h3><%= t('elo.game_systems') %></h3>
      <%= form_with url: elo_path, method: :get, local: true do %>
        <%= select_tag :game_system_id,
                       options_from_collection_for_select(@systems.sort_by(&:localized_name), :id, :localized_name, @system&.id),
                       include_blank: t('elo.select_system'),
                       onchange: 'this.form.submit()' %>
      <% end %>
    </div>
  </div>

  <% if @standings.present? %>
    <div class="card">
      <div class="card-header">
        <h3><%= t('elo.standings') %></h3>
        <p class="card-date"><%= @system&.localized_name %></p>
      </div>
      <div class="card-body">
        <table style="width:100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:0.25rem 0;">#</th>
              <th style="text-align:left; padding:0.25rem 0;"><%= t('elo.player') %></th>
              <th style="text-align:right; padding:0.25rem 0;"><%= t('elo.rating') %></th>
              <th style="text-align:right; padding:0.25rem 0;"><%= t('elo.count') %></th>
            </tr>
          </thead>
          <tbody>
            <% @standings.each do |entry| %>
              <% if entry[:separator] %>
                <tr>
                  <td colspan="4" style="padding:0.25rem 0; text-align:center; color: var(--gray-600);">***</td>
                </tr>
              <% else %>
                <% row = entry[:row] %>
                <% is_current = (Current.user && row.user_id == Current.user.id) %>
                <tr>
                  <td style="padding:0.25rem 0;"><%= entry[:rank] %></td>
              <td style="padding:0.25rem 0;">
                <% name = is_current ? content_tag(:strong, row.user.username) : row.user.username %>
                <%= link_to name, user_path(row.user) %>
              </td>
                  <td style="padding:0.25rem 0; text-align:right;"><%= row.rating %></td>
                  <td style="padding:0.25rem 0; text-align:right;"><%= row.games_played %></td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <div id="games-list">
    <% @events.each do |event| %>
      <div class="card">
        <div class="card-header">
          <h3><%= t('games.game_of') %> <%= event.game_system.localized_name %></h3>
          <p class="card-date"><%= l(event.played_at, format: :card) %></p>
          <% if event.tournament.present? %>
          <p class="card-date">
            <%= t('games.tournament_label', default: 'Tournament') %>:
            <%= link_to event.tournament.name, tournament_path(event.tournament) %>
          </p>
        <% end %>
        </div>
        <div class="card-body">
          <% parts = event.game_participations.includes(:user).to_a %>
          <% a = parts[0]; b = parts[1] %>
          <div class="card-row">
            <div class="player">
              <%= a&.user&.username %>
              <% if a&.faction %>
                <div class="card-date"><%= a.faction.localized_name %></div>
              <% end %>
              <% if a %>
                <% ch = @elo_changes_map[[event.id, a.user_id]] %>
                <% if ch %>
                  <div class="card-date">(<%= ch.rating_before %> → <%= ch.rating_after %>)</div>
                <% end %>
              <% end %>
            </div>
            <div class="score"><%= [a&.score, b&.score].compact.join(' - ') %></div>
            <div class="player" style="text-align: right;">
              <%= b&.user&.username %>
              <% if b&.faction %>
                <div class="card-date"><%= b.faction.localized_name %></div>
              <% end %>
              <% if b %>
                <% ch = @elo_changes_map[[event.id, b.user_id]] %>
                <% if ch %>
                  <div class="card-date">(<%= ch.rating_before %> → <%= ch.rating_after %>)</div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div> 