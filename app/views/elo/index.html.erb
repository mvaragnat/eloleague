<div class="games-container">
  <div class="page-header">
    <h1><%= t('elo.title') %></h1>
  </div>

  <div class="card">
    <div class="card-body">
      <%= form_with url: elo_path, method: :get, local: true do %>
        <%= select_tag :game_system_id,
                       options_from_collection_for_select(@systems.sort_by(&:localized_name), :id, :localized_name, @system&.id),
                       include_blank: t('elo.select_system'),
                       onchange: 'this.form.submit()' %>
      <% end %>
    </div>
  </div>

  <% if @standings.present? %>
    <div class="card">
      <div class="card-header">
        <h3><%= t('elo.standings') %></h3>
        <p class="card-date"><%= @system&.localized_name %></p>
      </div>
      <div class="card-body">
        <table style="width:100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:0.25rem 0;">#</th>
              <th style="text-align:left; padding:0.25rem 0;"><%= t('elo.player') %></th>
              <th style="text-align:right; padding:0.25rem 0;"><%= t('elo.rating') %></th>
            </tr>
          </thead>
          <tbody>
            <% @standings.each do |entry| %>
              <% row = entry[:row] %>
              <tr>
                <td style="padding:0.25rem 0;"><%= entry[:rank] %></td>
                <td style="padding:0.25rem 0;"><%= row.user.username %></td>
                <td style="padding:0.25rem 0; text-align:right;"><%= row.rating %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <div id="games-list">
    <% @events.each do |event| %>
      <div class="card">
        <div class="card-header">
          <h3><%= t('games.game_of') %> <%= event.game_system.localized_name %></h3>
          <p class="card-date"><%= l(event.played_at, format: :card) %></p>
        </div>
        <div class="card-body">
          <% parts = event.game_participations.includes(:user).to_a %>
          <% a = parts[0]; b = parts[1] %>
          <div class="card-row">
            <div class="player">
              <%= a&.user&.username %>
              <% if a %>
                <% ch = @elo_changes_map[[event.id, a.user_id]] %>
                <% if ch %>
                  <div class="card-date">(<%= ch.rating_before %> → <%= ch.rating_after %>)</div>
                <% end %>
              <% end %>
            </div>
            <div class="score"><%= [a&.score, b&.score].compact.join(' - ') %></div>
            <div class="player" style="text-align: right;">
              <%= b&.user&.username %>
              <% if b %>
                <% ch = @elo_changes_map[[event.id, b.user_id]] %>
                <% if ch %>
                  <div class="card-date">(<%= ch.rating_before %> → <%= ch.rating_after %>)</div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div> 