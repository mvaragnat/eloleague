<div class="games-container">
  <h1><%= @tournament.name %></h1>
  <p class="card-date"><%= @tournament.game_system.name %> · <%= @tournament.format %> · <strong><%= @tournament.state_label %></strong></p>
  <p class="card-date"><%= t('tournaments.show.organizer', default: 'Organizer') %>: <%= @tournament.creator.username %></p>

  <div style="margin:1rem 0;">
    <% if @tournament.registrations.exists?(user: Current.user) %>
      <%= button_to t('tournaments.show.unregister'), unregister_tournament_path(@tournament), method: :delete, class: 'btn' %>
      <%= button_to t('tournaments.show.check_in'), check_in_tournament_path(@tournament), method: :post, class: 'btn' %>
    <% elsif @tournament.registrations_open? %>
      <%= button_to t('tournaments.show.register'), register_tournament_path(@tournament), method: :post, class: 'btn btn-primary' %>
    <% end %>
  </div>

  <% if @tournament.elimination? %>
    <div data-controller="tabs">
      <div style="display:flex; gap:0.5rem; margin-bottom:0.75rem; flex-wrap:wrap;">
        <a href="#" data-action="click->tabs#select" data-index="0" data-tabs-target="tab" class="btn btn-primary" aria-selected="true"><%= t('tournaments.show.tabs.bracket', default: 'Bracket') %></a>
        <a href="#" data-action="click->tabs#select" data-index="1" data-tabs-target="tab" class="btn" aria-selected="false"><%= t('tournaments.show.tabs.participants', default: 'Participants') %></a>
        <% if @tournament.creator == Current.user %>
          <a href="#" data-action="click->tabs#select" data-index="2" data-tabs-target="tab" class="btn" aria-selected="false"><%= t('tournaments.show.tabs.admin', default: 'Admin') %></a>
        <% end %>
      </div>

      <!-- Bracket panel: rounds as nested tabs -->
      <div data-tabs-target="panel">
        <% if @rounds.any? %>
          <div data-controller="tabs">
            <div style="display:flex; gap:0.5rem; margin-bottom:0.75rem; flex-wrap:wrap;">
              <% @rounds.each_with_index do |r, i| %>
                <a href="#" data-action="click->tabs#select" data-index="<%= i %>" data-tabs-target="tab" class="btn <%= i.zero? ? 'btn-primary' : '' %>" aria-selected="<%= i.zero? %>"><%= t('tournaments.show.round_label', default: 'Round %{n}', n: r.number) %></a>
              <% end %>
            </div>
            <% @rounds.each_with_index do |r, i| %>
              <div data-tabs-target="panel" style="<%= i.zero? ? '' : 'display:none;' %>">
                <% if r.matches.any? %>
                  <ul style="list-style:none; padding:0;">
                    <% r.matches.includes(:a_user, :b_user).each do |m| %>
                      <li class="card" style="margin-bottom:0.5rem;">
                        <div class="card-body" style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                          <% if m.game_event_id.present? %>
                            <% pa = m.game_event.game_participations.find_by(user: m.a_user) %>
                            <% pb = m.game_event.game_participations.find_by(user: m.b_user) %>
                            <div class="player" style="<%= pa.score.to_i > pb.score.to_i ? 'color: var(--green-500); font-weight:700;' : '' %>"><%= m.a_user.username %></div>
                            <div class="score"><%= pa&.score %> - <%= pb&.score %></div>
                            <div class="player" style="text-align:right; <%= pb.score.to_i > pa.score.to_i ? 'color: var(--green-500); font-weight:700;' : '' %>"><%= m.b_user.username %></div>
                          <% else %>
                            <span><%= m.a_user.username %> vs <%= m.b_user.username %></span>
                            <span class="card-date"><%= t('tournaments.show.pending', default: 'Pending') %></span>
                            <%= link_to t('tournaments.open'), tournament_tournament_match_path(@tournament, m), class: 'btn' %>
                          <% end %>
                        </div>
                      </li>
                    <% end %>
                  </ul>
                <% else %>
                  <p class="card-date"><%= t('tournaments.show.no_matches', default: 'No matches yet') %></p>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="card-date"><%= t('tournaments.show.no_rounds', default: 'No rounds yet') %></p>
        <% end %>
      </div>

      <!-- Participants panel -->
      <div data-tabs-target="panel" style="display:none;">
        <div class="card">
          <div class="card-header">
            <h3><%= t('tournaments.show.registrations') %></h3>
          </div>
          <div class="card-body">
            <ul style="list-style:none; padding:0;">
              <% @registrations.each do |r| %>
                <li><%= r.user.username %> (<%= r.status %>)</li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>

      <% if @tournament.creator == Current.user %>
        <!-- Admin panel -->
        <div data-tabs-target="panel" style="display:none;">
          <div class="card">
            <div class="card-header">
              <h3><%= t('tournaments.show.admin') %></h3>
            </div>
            <div class="card-body" style="display:flex; gap:0.5rem; flex-wrap:wrap;">
              <% if @tournament.registrations_open? %>
                <%= button_to t('tournaments.show.lock_registration'), lock_registration_tournament_path(@tournament), method: :post, class: 'btn' %>
              <% end %>
              <%= button_to t('tournaments.show.generate_pairings'), generate_pairings_tournament_path(@tournament), method: :post, class: 'btn' %>
              <%= button_to t('tournaments.show.close_round'), close_round_tournament_path(@tournament), method: :post, class: 'btn' %>
              <%= button_to t('tournaments.show.finalize'), finalize_tournament_path(@tournament), method: :post, class: 'btn' %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <!-- Non-elimination formats fallback: current simple sections -->
    <div style="margin:1rem 0; display:flex; gap:0.5rem; flex-wrap:wrap;">
      <% unless @tournament.open? %>
        <%= link_to 'Rounds', tournament_tournament_rounds_path(@tournament), class: 'btn' %>
      <% end %>
      <%= link_to 'Matches', tournament_tournament_matches_path(@tournament), class: 'btn' %>
    </div>

    <% if @tournament.creator == Current.user %>
      <div class="card">
        <div class="card-header">
          <h3><%= t('tournaments.show.admin') %></h3>
        </div>
        <div class="card-body" style="display:flex; gap:0.5rem; flex-wrap:wrap;">
          <% if @tournament.registrations_open? %>
            <%= button_to t('tournaments.show.lock_registration'), lock_registration_tournament_path(@tournament), method: :post, class: 'btn' %>
          <% end %>
          <% unless @tournament.open? %>
            <%= button_to t('tournaments.show.generate_pairings'), generate_pairings_tournament_path(@tournament), method: :post, class: 'btn' %>
            <%= button_to t('tournaments.show.close_round'), close_round_tournament_path(@tournament), method: :post, class: 'btn' %>
          <% end %>
          <%= button_to t('tournaments.show.finalize'), finalize_tournament_path(@tournament), method: :post, class: 'btn' %>
        </div>
      </div>

      <div class="card" style="margin-top:1rem;">
        <div class="card-header">
          <h3><%= t('tournaments.show.registrations') %></h3>
        </div>
        <div class="card-body">
          <ul style="list-style:none; padding:0;">
            <% @registrations.each do |r| %>
              <li><%= r.user.username %> (<%= r.status %>)</li>
            <% end %>
          </ul>
        </div>
      </div>

      <div class="card" style="margin-top:1rem;">
        <div class="card-header">
          <h3><%= t('tournaments.show.recent_matches') %></h3>
        </div>
        <div class="card-body">
          <ul style="list-style:none; padding:0;">
            <% @matches.each do |m| %>
              <% if m.game_event_id.present? %>
                <% pa = m.game_event.game_participations.find_by(user: m.a_user) %>
                <% pb = m.game_event.game_participations.find_by(user: m.b_user) %>
                <li class="card-row" style="margin-bottom:0.5rem;">
                  <div class="player" style="<%= pa.score.to_i > pb.score.to_i ? 'color: var(--green-500); font-weight:700;' : '' %>"><%= m.a_user.username %></div>
                  <div class="score"><%= pa&.score %> - <%= pb&.score %></div>
                  <div class="player" style="text-align:right; <%= pb.score.to_i > pa.score.to_i ? 'color: var(--green-500); font-weight:700;' : '' %>"><%= m.b_user.username %></div>
                </li>
              <% else %>
                <li><%= m.a_user.username %> vs <%= m.b_user.username %> — <%= t('tournaments.show.pending', default: 'Pending') %></li>
              <% end %>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>
  <% end %>
</div> 