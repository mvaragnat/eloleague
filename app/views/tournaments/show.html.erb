<div class="games-container">
  <h1><%= @tournament.name %></h1>
  <p class="card-date"><%= @tournament.game_system.name %> · <%= @tournament.format %> · <strong><%= @tournament.state_label %></strong></p>
  <p class="card-date"><%= t('tournaments.show.organizer', default: 'Organizer') %>: <%= @tournament.creator.username %></p>

  <div style="margin:1rem 0; display:flex; flex-direction:column; gap:0.5rem;">
    <% if @is_registered %>
      <% if @tournament.registrations_open? && @my_registration && @my_registration.status != 'checked_in' %>
        <% if @my_registration.faction_id.blank? %>
          <p class="card-date" style="color:#b45309;"><%= t('tournaments.show.faction_required_hint', default: 'Please select your faction in the Participants tab before checking in.') %></p>
        <% end %>
        <%= button_to t('tournaments.show.check_in'), check_in_tournament_path(@tournament), method: :post, class: 'btn btn-primary' %>
      <% end %>
      <%= button_to t('tournaments.show.unregister'), unregister_tournament_path(@tournament), method: :delete, class: 'btn' %>
    <% elsif @tournament.registrations_open? %>
      <% if authenticated? %>
        <%= button_to t('tournaments.show.register'), register_tournament_path(@tournament), method: :post, class: 'btn btn-primary' %>
      <% else %>
        <p class="card-date">
          <%= t('tournaments.show.sign_in_to_register_html', default: 'Please <a href="%{url}">sign in</a> to register.', url: new_session_path) %>
        </p>
      <% end %>
    <% end %>
  </div>

  <div data-controller="tabs" data-tabs-active-index-value="<%= @active_tab_index %>">
    <div style="display:flex; gap:0.5rem; margin-bottom:0.75rem; flex-wrap:wrap;">
      <% if @tournament.elimination? %>
        <a href="#" data-action="click->tabs#select" data-index="0" data-tabs-target="tab" class="btn btn-primary" aria-selected="true"><%= t('tournaments.show.tabs.bracket', default: 'Bracket') %></a>
        <a href="#" data-action="click->tabs#select" data-index="1" data-tabs-target="tab" class="btn" aria-selected="false"><%= t('tournaments.show.tabs.participants', default: 'Participants') %></a>
        <% if @tournament.creator == Current.user %>
          <a href="#" data-action="click->tabs#select" data-index="2" data-tabs-target="tab" class="btn" aria-selected="false"><%= t('tournaments.show.tabs.admin', default: 'Admin') %></a>
        <% end %>
      <% else %>
        <% if @tournament.open? %>
          <a href="#" data-action="click->tabs#select" data-index="0" data-tabs-target="tab" class="btn btn-primary" aria-selected="true"><%= t('tournaments.show.tabs.matches', default: 'Matches') %></a>
          <a href="#" data-action="click->tabs#select" data-index="1" data-tabs-target="tab" class="btn" aria-selected="false"><%= t('tournaments.show.tabs.participants', default: 'Participants') %></a>
          <a href="#" data-action="click->tabs#select" data-index="2" data-tabs-target="tab" class="btn" aria-selected="false"><%= t('tournaments.show.tabs.ranking', default: 'Ranking') %></a>
          <% if @tournament.creator == Current.user %>
            <a href="#" data-action="click->tabs#select" data-index="3" data-tabs-target="tab" class="btn" aria-selected="false"><%= t('tournaments.show.tabs.admin', default: 'Admin') %></a>
          <% end %>
        <% else %>
          <a href="#" data-action="click->tabs#select" data-index="0" data-tabs-target="tab" class="btn btn-primary" aria-selected="true"><%= t('tournaments.show.tabs.rounds', default: 'Rounds') %></a>
          <a href="#" data-action="click->tabs#select" data-index="1" data-tabs-target="tab" class="btn" aria-selected="false"><%= t('tournaments.show.tabs.participants', default: 'Participants') %></a>
          <a href="#" data-action="click->tabs#select" data-index="2" data-tabs-target="tab" class="btn" aria-selected="false"><%= t('tournaments.show.tabs.ranking', default: 'Ranking') %></a>
          <% if @tournament.creator == Current.user %>
            <a href="#" data-action="click->tabs#select" data-index="3" data-tabs-target="tab" class="btn" aria-selected="false"><%= t('tournaments.show.tabs.admin', default: 'Admin') %></a>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <% if @tournament.elimination? %>
      <!-- Bracket panel -->
      <div data-tabs-target="panel">
        <div class="card" style="margin-bottom:0.75rem;">
          <div class="card-body">
            <%= render_svg_bracket(@tournament, @rounds) %>
          </div>
        </div>
      </div>

      <!-- Participants panel -->
      <div data-tabs-target="panel" style="display:none;">
        <div class="card">
          <div class="card-body">
            <ul style="list-style:none; padding:0;">
              <% @registrations.each do |r| %>
                <li><%= r.user.username %> (<%= r.status %>)</li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>

      <% if @tournament.creator == Current.user %>
        <!-- Admin panel -->
        <div data-tabs-target="panel" style="display:none;">
          <div class="card">
            <div class="card-body" style="display:flex; flex-direction:column; gap:1rem;">
              <section>
                <h3 style="margin:0 0 0.25rem 0; font-size:1rem; font-weight:600;">
                  <%= t('tournaments.show.admin.actions', default: 'Actions') %>
                </h3>
                <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
                  <% if @tournament.registrations_open? %>
                    <span class="card-date" style="font-style:normal;"><%= t('tournaments.show.lock_warning') %></span>
                    <%= button_to t('tournaments.show.lock_registration'), lock_registration_tournament_path(@tournament), method: :post, class: 'btn' %>
                  <% end %>

                  <% if @tournament.running? %>
                    <%= button_to t('tournaments.show.finalize'), finalize_tournament_path(@tournament), method: :post, class: 'btn' %>
                  <% end %>
                </div>
              </section>

              <section>
                <h3 style="margin:0 0 0.25rem 0; font-size:1rem; font-weight:600;">
                  <%= t('tournaments.show.admin.strategies', default: 'Strategies') %>
                </h3>
                <%= render 'strategy_settings', show_pairing: false %>
              </section>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <% if @tournament.open? %>
        <!-- Matches panel for Open format -->
        <div data-tabs-target="panel">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
            <h3 style="margin:0;"><%= t('tournaments.show.matches', default: 'Matches') %></h3>
            <% if @tournament.running? && (@is_registered || (@tournament.creator == Current.user)) %>
              <%= link_to t('games.add'), new_tournament_tournament_match_path(@tournament), class: "btn btn-primary", data: { turbo_frame: "modal" } %>
            <% end %>
          </div>
          <ul id="matches-list" style="list-style:none; padding:0;">
            <% if @matches.any? %>
              <% @matches.each do |m| %>
                <li style="margin:0 0 0.5rem 0; display:flex; justify-content:center;">
                  <%= content_tag :svg, width: 240, height: 68 do %>
                    <%= small_match_box(@tournament, m, 0, 0, width: 240, show_seeds: false) %>
                  <% end %>
                </li>
              <% end %>
            <% else %>
              <div id="no-matches-message" class="card">
                <p class="card-date"><%= t('tournaments.show.no_matches', default: 'No matches yet') %></p>
              </div>
            <% end %>
          </ul>
        </div>

        <!-- Participants panel -->
        <div data-tabs-target="panel" style="display:none;">
          <div class="card">
            <div class="card-body">
              <div style="display:grid; grid-template-columns: 1fr 1fr auto; column-gap:1rem; row-gap:0.25rem; align-items:center;">
                <% @registrations.each do |r| %>
                  <div><%= r.user.username %></div>
                  <div>
                    <% can_edit = (Current.user && (Current.user.id == r.user_id || Current.user.id == @tournament.creator_id)) %>
                    <% if can_edit %>
                      <%= form_with(model: r, url: tournament_tournament_registration_path(@tournament, r), method: :patch, scope: :tournament_registration) do |f| %>
                        <%= f.select :faction_id, Game::Faction.where(game_system_id: @tournament.game_system_id).order(:name).map { |fa| [fa.name, fa.id] }, { include_blank: t('tournaments.show.select_faction', default: 'Select faction') }, { onchange: 'this.form.submit()' } %>
                      <% end %>
                    <% else %>
                      <span class="card-date"><%= r.faction&.name || t('tournaments.show.no_faction', default: 'No faction') %></span>
                    <% end %>
                  </div>
                  <div class="card-date" style="text-align:right;"><%= r.status %></div>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Ranking panel -->
        <div data-tabs-target="panel" style="display:none;">
          <div class="card">
            <div class="card-body">
              <% if @standings.any? %>
                <table style="width:100%; border-collapse: collapse;">
                  <thead>
                    <tr>
                      <th style="text-align:left; padding:0.25rem 0;">#</th>
                      <th style="text-align:left; padding:0.25rem 0;"><%= t('elo.player') %></th>
                      <th style="text-align:right; padding:0.25rem 0;"><%= t('tournaments.show.standings.games_played', default: 'Games Played') %></th>
                      <th style="text-align:right; padding:0.25rem 0;"><%= t('tournaments.show.standings.points', default: 'Points') %></th>
                      <th style="text-align:right; padding:0.25rem 0;"><%= t('tournaments.show.standings.score', default: 'Score') %></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @standings.each_with_index do |row, idx| %>
                      <tr>
                        <td style="padding:0.25rem 0;"><%= idx + 1 %></td>
                        <td style="padding:0.25rem 0;"><%= row[:user].username %></td>
                        <td style="padding:0.25rem 0; text-align:right;"><%= (@tournament.matches.where(a_user: row[:user]).or(@tournament.matches.where(b_user: row[:user])).where.not(result: 'pending').count) %></td>
                        <td style="padding:0.25rem 0; text-align:right;"><%= row[:points] %></td>
                        <td style="padding:0.25rem 0; text-align:right;"><%= row[:tiebreak1] %></td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              <% else %>
                <p class="card-date"><%= t('tournaments.show.no_standings', default: 'No results yet') %></p>
              <% end %>
            </div>
          </div>
        </div>

        <% if @tournament.creator == Current.user %>
          <!-- Admin panel -->
          <div data-tabs-target="panel" style="display:none;">
            <div class="card">
              <div class="card-body" style="display:flex; flex-direction:column; gap:1rem;">
                <section>
                  <h3 style="margin:0 0 0.25rem 0; font-size:1rem; font-weight:600;">
                    <%= t('tournaments.show.admin.actions', default: 'Actions') %>
                  </h3>
                  <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
                    <% if @tournament.registrations_open? %>
                      <span class="card-date" style="font-style:normal;"><%= t('tournaments.show.lock_warning') %></span>
                      <%= button_to t('tournaments.show.lock_registration'), lock_registration_tournament_path(@tournament), method: :post, class: 'btn' %>
                    <% end %>

                    <% if @tournament.running? %>
                      <% if @can_move_to_next_round %>
                        <%= button_to t('tournaments.show.move_to_next_round', default: 'Move to next round'), next_round_tournament_path(@tournament), method: :post, class: 'btn btn-primary' %>
                      <% else %>
                        <button class="btn" disabled title="<%= @move_block_reason %>"><%= t('tournaments.show.move_to_next_round', default: 'Move to next round') %></button>
                        <% if @move_block_reason %>
                          <span class="card-date" style="font-style:normal;"><%= @move_block_reason %></span>
                        <% end %>
                      <% end %>

                      <%= button_to t('tournaments.show.finalize'), finalize_tournament_path(@tournament), method: :post, class: 'btn' %>
                    <% end %>

                    <div style="flex-basis:100%; height:1px;"></div>
                    <div style="width:100%;">
                      <p class="card-date" style="font-style:normal;"><%= t('tournaments.show.strategies.explanation', default: 'Ranking uses Points, then Tie-break #1, then Tie-break #2. Pairings avoid repeat matches when possible.') %></p>
                      <%= render 'strategy_settings', show_pairing: false %>
                    </div>
                  </div>
                </section>
              </div>
            </div>
          </div>
        <% end %>
      <% else %>
        <!-- Rounds panel -->
        <div data-tabs-target="panel">
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:0.5rem; align-items:start;">
            <% @rounds.each do |round| %>
              <div class="card">
                <div class="card-header">
                  <h3><%= t('tournaments.show.round_label', n: round.number) %></h3>
                </div>
                <div class="card-body">
                  <% if round.matches.any? %>
                    <ul style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:0.5rem;">
                      <% round.matches.each do |m| %>
                        <li style="margin:0; display:flex; justify-content:center;">
                          <%= content_tag :svg, width: 240, height: 68 do %>
                            <%= small_match_box(@tournament, m, 0, 0, width: 240, show_seeds: false) %>
                          <% end %>
                        </li>
                      <% end %>
                    </ul>
                  <% else %>
                    <p class="card-date"><%= t('tournaments.show.no_matches', default: 'No matches yet') %></p>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Participants panel -->
        <div data-tabs-target="panel" style="display:none;">
          <div class="card">
            <div class="card-body">
              <div style="display:grid; grid-template-columns: 1fr 1fr auto; column-gap:1rem; row-gap:0.25rem; align-items:center;">
                <% @registrations.each do |r| %>
                  <div><%= r.user.username %></div>
                  <div>
                    <% can_edit = (Current.user && (Current.user.id == r.user_id || Current.user.id == @tournament.creator_id)) %>
                    <% if can_edit %>
                      <%= form_with(model: r, url: tournament_tournament_registration_path(@tournament, r), method: :patch, scope: :tournament_registration) do |f| %>
                        <%= f.select :faction_id, Game::Faction.where(game_system_id: @tournament.game_system_id).order(:name).map { |fa| [fa.name, fa.id] }, { include_blank: t('tournaments.show.select_faction', default: 'Select faction') }, { onchange: 'this.form.submit()' } %>
                      <% end %>
                    <% else %>
                      <span class="card-date"><%= r.faction&.name || t('tournaments.show.no_faction', default: 'No faction') %></span>
                    <% end %>
                  </div>
                  <div class="card-date" style="text-align:right;"><%= r.status %></div>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Ranking panel -->
        <div data-tabs-target="panel" style="display:none;">
          <div class="card">
            <div class="card-body">
              <% if @standings.any? %>
                <table style="width:100%; border-collapse: collapse;">
                  <thead>
                    <tr>
                      <th style="text-align:left; padding:0.25rem 0;">#</th>
                      <th style="text-align:left; padding:0.25rem 0;"><%= t('elo.player') %></th>
                      <th style="text-align:right; padding:0.25rem 0;"><%= t('tournaments.show.standings.games_played', default: 'Games Played') %></th>
                      <th style="text-align:right; padding:0.25rem 0;"><%= t('tournaments.show.standings.points', default: 'Points') %></th>
                      <th style="text-align:right; padding:0.25rem 0;"><%= t('tournaments.show.standings.score', default: 'Score') %></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @standings.each_with_index do |row, idx| %>
                      <tr>
                        <td style="padding:0.25rem 0;"><%= idx + 1 %></td>
                        <td style="padding:0.25rem 0;"><%= row[:user].username %></td>
                        <td style="padding:0.25rem 0; text-align:right;"><%= (@tournament.matches.where(a_user: row[:user]).or(@tournament.matches.where(b_user: row[:user])).where.not(result: 'pending').count) %></td>
                        <td style="padding:0.25rem 0; text-align:right;"><%= row[:points] %></td>
                        <td style="padding:0.25rem 0; text-align:right;"><%= row[:tiebreak1] %></td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              <% else %>
                <p class="card-date"><%= t('tournaments.show.no_standings', default: 'No results yet') %></p>
              <% end %>
            </div>
          </div>
        </div>

        <% if @tournament.creator == Current.user %>
          <!-- Admin panel -->
          <div data-tabs-target="panel" style="display:none;">
            <div class="card">
              <div class="card-body" style="display:flex; flex-direction:column; gap:1rem;">
                <section>
                  <h3 style="margin:0 0 0.25rem 0; font-size:1rem; font-weight:600;">
                    <%= t('tournaments.show.admin.actions', default: 'Actions') %>
                  </h3>
                  <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
                    <% if @tournament.registrations_open? %>
                      <span class="card-date" style="font-style:normal;"><%= t('tournaments.show.lock_warning') %></span>
                      <%= button_to t('tournaments.show.lock_registration'), lock_registration_tournament_path(@tournament), method: :post, class: 'btn' %>
                    <% end %>

                    <% if @tournament.running? %>
                      <% if @can_move_to_next_round %>
                        <%= button_to t('tournaments.show.move_to_next_round', default: 'Move to next round'), next_round_tournament_path(@tournament), method: :post, class: 'btn btn-primary' %>
                      <% else %>
                        <button class="btn" disabled title="<%= @move_block_reason %>"><%= t('tournaments.show.move_to_next_round', default: 'Move to next round') %></button>
                        <% if @move_block_reason %>
                          <span class="card-date" style="font-style:normal;"><%= @move_block_reason %></span>
                        <% end %>
                      <% end %>

                      <%= button_to t('tournaments.show.finalize'), finalize_tournament_path(@tournament), method: :post, class: 'btn' %>
                    <% end %>
                  </div>
                </section>

                <section>
                  <h3 style="margin:0 0 0.25rem 0; font-size:1rem; font-weight:600;">
                    <%= t('tournaments.show.admin.strategies', default: 'Strategies') %>
                  </h3>
                  <%= render 'strategy_settings', show_pairing: !@tournament.open? %>
                </section>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>

<%= turbo_frame_tag "modal" %> 