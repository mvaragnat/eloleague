<div class="card">
  <div class="card-body">
    <div style="display:grid; grid-template-columns: 1fr 1fr auto; column-gap:1rem; row-gap:0.25rem; align-items:center;">
      <% registrations.each do |r| %>
        <div><%= r.user.username %></div>
        <div>
          <% can_edit = (Current.user && (Current.user.id == r.user_id || Current.user.id == tournament.creator_id)) %>
          <% if can_edit %>
            <%= form_with(model: r, url: tournament_tournament_registration_path(tournament, r), method: :patch, scope: :tournament_registration) do |f| %>
              <%= hidden_field_tag :tab, 2 %>
              <%= f.select :faction_id,
                           Game::Faction.where(game_system_id: tournament.game_system_id)
                             .to_a
                             .sort_by { |fa| fa.localized_name(I18n.locale) }
                             .map { |fa| [fa.localized_name(I18n.locale), fa.id] },
                           { include_blank: t('tournaments.show.select_faction', default: 'Select faction') },
                           { onchange: 'this.form.submit()' } %>
            <% end %>
          <% else %>
            <span class="card-date"><%= r.faction&.localized_name || t('tournaments.show.no_faction', default: 'No faction') %></span>
          <% end %>
        </div>
        <div class="card-date" style="text-align:right; display:flex; gap:0.5rem; justify-content:flex-end; align-items:center;">
          <span><%= r.status %></span>
          <% if Current.user && Current.user.id == tournament.creator_id %>
            <%# Admin can toggle status regardless of faction/list requirements %>
            <% new_status = r.status == 'checked_in' ? 'pending' : 'checked_in' %>
            <%= form_with(model: r,
                          url: tournament_tournament_registration_path(tournament, r),
                          method: :patch,
                          scope: :tournament_registration) do |f| %>
              <%= f.hidden_field :status, value: new_status %>
              <%= hidden_field_tag :tab, 2 %>
              <%= f.submit(new_status == 'checked_in' ? t('tournaments.show.actions.toggle_status_to_checked_in') : t('tournaments.show.actions.toggle_status_to_pending'), class: 'btn') %>
            <% end %>
          <% end %>
          <%# Army list button/modal visibility %>
          <% can_view_list = tournament.running? && r.army_list.present? %>
          <% if can_view_list %>
            <%= link_to t('tournaments.show.view_army_list', default: 'Army list').html_safe,
                        tournament_tournament_registration_path(tournament, r),
                        class: 'btn',
                        data: { turbo_frame: 'modal' } %>
          <% elsif Current.user && (Current.user.id == r.user_id || Current.user.id == tournament.creator_id) %>
            <%= link_to t('tournaments.show.edit_army_list', default: 'Edit list').html_safe,
                        tournament_tournament_registration_path(tournament, r),
                        class: 'btn',
                        data: { turbo_frame: 'modal' } %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  </div>


