<%# locals: form:, preselected_user: nil, preselected_removable: true, tournament_id: nil %>

<div style="margin-top: 1rem; display:grid; gap:0.75rem;">
  <% i = 0 %>
  <%= form.fields_for :game_participations do |p_form| %>
    <% i += 1 %>
    <div class="participation-block" style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; align-items:start; border:1px solid #e5e7eb; border-radius:0.5rem; padding:0.75rem;">
      <div style="grid-column: 1 / -1;">
        <% if i == 1 && preselected_user.present? %>
          <% removable_attr = preselected_removable ? 'true' : 'false' %>
          <% preselected_faction_id = nil %>
          <% if tournament_id.present? %>
            <% reg = Tournament::Registration.find_by(tournament_id: tournament_id, user_id: preselected_user.id) %>
            <% preselected_faction_id = reg&.faction_id %>
          <% end %>
          <div data-controller="player-search"
               data-player-search-max-selections-value="1"
               data-player-search-removable-value="<%= removable_attr %>"
               data-player-search-preselected-user-id-value="<%= preselected_user.id %>"
               data-player-search-preselected-username-value="<%= preselected_user.username %>"
               <%= preselected_faction_id.present? ? "data-player-search-preselected-faction-id-value=\"#{preselected_faction_id}\"" : "" %>
               <%= tournament_id.present? ? "data-player-search-tournament-id-value=\"#{tournament_id}\"" : "" %>>
        <% else %>
          <div data-controller="player-search" data-player-search-max-selections-value="1" data-player-search-removable-value="true" <%= tournament_id.present? ? "data-player-search-tournament-id-value=\"#{tournament_id}\"" : "" %>>
        <% end %>
            <label><%= t('games.new.select_player', default: 'Select player') %></label>
            <div data-player-search-target="container">
              <input type="text"
                     data-player-search-target="input"
                     data-action="input->player-search#search"
                     placeholder="<%= t('games.new.search_placeholder') %>">
              <div data-player-search-target="results" class="card" style="padding:0.25rem; margin-top:0.25rem; max-height: 220px; overflow:auto;"></div>
            </div>
            <div data-player-search-target="selected" style="margin-top: 0.5rem;"></div>
          </div>
      </div>
      <div>
        <%= p_form.label :score, t('games.new.score', default: 'Score') %>
        <%= p_form.number_field :score, min: 0 %>
        <%= p_form.label :secondary_score, t('games.new.secondary_score', default: 'Secondary score'), style: 'display:block; margin-top:0.25rem;' %>
        <%= p_form.number_field :secondary_score, min: 0 %>
        <%= p_form.label :faction_id, t('games.new.faction', default: 'Faction'), style: 'display:block; margin-top:0.5rem;' %>
        <%= p_form.select :faction_id, [], { prompt: t('games.new.select_faction', default: 'Select faction') }, { data: { faction_select: true } } %>
        <%= p_form.hidden_field :user_id %>
      </div>
      <div>
        <%= p_form.label :army_list, t('games.new.army_list', default: 'Army list') %>
        <%= p_form.text_area :army_list, rows: 8, style: 'width:100%;', placeholder: t('games.new.army_list_placeholder', default: 'Paste your army list here (optional)') %>
      </div>
    </div>
  <% end %>
 </div>


